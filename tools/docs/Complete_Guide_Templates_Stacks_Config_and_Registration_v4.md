# Complete Guide: Templates, Stacks, Configuration, and Registration v4

**Platform:** cloud-0.7
**Architecture:** 4.5
**Version:** 4.5 (With Cross-Stack Dependencies and Dynamic Pulumi.yaml)
**Date:** 2025-10-30
**Status:** ✅ With Output Support, Validation, and Cross-Stack Dependencies

---

## What's New in v4

This guide includes all v2 features plus comprehensive cross-stack dependency coverage:

- ✅ **Stack Templates Now Include Outputs** - Both inputs AND outputs declared
- ✅ **Automated Parameter Extraction** - Auto-generate templates from code
- ✅ **Template-First Validation** - Enforce code-template consistency
- ✅ **Enhanced Workflows** - Registration, validation, deployment all improved
- ✅ **Cross-Stack Dependency Outputs** - NEW: Complete network → database example
- ✅ **Deployment Configs** - Runtime configuration files explained
- ✅ **Real Implementation Details** - Based on actual 87% tested code

---

## Table of Contents

1. [Overview and Key Concepts](#overview-and-key-concepts)
2. [Critical Distinction: Stack Templates vs Deployment Templates](#critical-distinction-stack-templates-vs-deployment-templates)
3. [The Four Layers of the Architecture](#the-four-layers-of-the-architecture)
4. [Stack Implementations (Layer 2)](#stack-implementations-layer-2)
5. [Complete Configuration Flow](#complete-configuration-flow)
6. [3-Tier Parameter Resolution](#3-tier-parameter-resolution)
7. [Enhanced Stack Registration Process](#enhanced-stack-registration-process)
8. [Input Parameters: Declaration and Usage](#input-parameters-declaration-and-usage)
9. [Output Parameters: Declaration and Usage (NEW)](#output-parameters-declaration-and-usage)
10. [Template-First Validation (NEW)](#template-first-validation)
11. [DependencyResolver: Cross-Stack References](#dependencyresolver-cross-stack-references)
12. [Cross-Stack Dependency Outputs: Complete Example (NEW v4)](#cross-stack-dependency-outputs-complete-example)
13. [Directory Structure Complete Map](#directory-structure-complete-map)
14. [Example: Full Lifecycle Walkthrough](#example-full-lifecycle-walkthrough)
15. [Advanced Topics](#advanced-topics)
16. [Summary and Quick Reference](#summary-and-quick-reference)

---

## Overview and Key Concepts

### The Complete Picture (v2 Enhanced)

```
┌─────────────────────────────────────────────────────────────────┐
│              COMPLETE ARCHITECTURE v2 (ENHANCED)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Stack Templates (ENHANCED)   → Per-stack inputs AND outputs    │
│    (tools/templates/config/<stack>.yaml)                        │
│    • parameters.inputs  ◀── NEW: Explicit declarations          │
│    • parameters.outputs ◀── NEW: Output declarations            │
│                                                                  │
│  Deployment Templates         → Orchestration recipes            │
│    (tools/templates/default/default.yaml)                       │
│    • Defines which stacks                                       │
│    • Stack dependencies                                         │
│                                                                  │
│  Stack Code                   → Infrastructure as Code           │
│    (stacks/*/index.ts)                                          │
│    • Reads inputs via config.require/get                        │
│    • Exports outputs ◀── NEW: Must match template               │
│                                                                  │
│  Parameter Extractor (NEW)    → Auto-generate templates         │
│    • TypeScript AST parsing                                     │
│    • Extract inputs/outputs                                     │
│    • Infer types                                                │
│                                                                  │
│  Code Validator (NEW)         → Enforce consistency             │
│    • Compare code vs template                                   │
│    • Validate exports                                           │
│    • Report mismatches                                          │
│                                                                  │
│  Deployment Manifests         → User-editable orchestration       │
│    (deploy/.../deployment-manifest.yaml)                        │
│    • User customizes config overrides                           │
│    • Environment-specific settings                              │
│                                                                  │
│  Deployment Configs (NEW DOC)  → ⭐ What Pulumi Actually Reads  │
│    (deploy/.../config/*.yaml)                                   │
│    • Auto-generated by ConfigGenerator                          │
│    • One per stack per environment                              │
│    • Pulumi config format (key:value)                           │
│    • DO NOT EDIT MANUALLY                                       │
│                                                                  │
│  DependencyResolver           → Cross-stack references           │
│    (Read outputs from other stacks)                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Critical Distinction: Stack Templates vs Deployment Templates

### Stack Template Files (v2 Enhanced)

**Purpose:** Define input parameters AND output declarations for a **single stack**

**Location:** `./cloud/tools/templates/config/<stack-name>.yaml`

**Created by:** `cloud register-stack` (now with auto-extraction)

**Enhanced Example: network.yaml (v2)**
```yaml
# ./cloud/tools/templates/config/network.yaml
name: network
description: Core networking infrastructure
dependencies: []
priority: 100

# ENHANCED v2: Explicit parameter declarations
parameters:
  inputs:
    vpcCidr:
      type: string
      required: true
      secret: false
      description: VPC CIDR block (e.g., 10.0.0.0/16)

    region:
      type: string
      required: false
      secret: false
      default: us-east-1
      description: AWS region for deployment

    availabilityZones:
      type: number
      required: true
      secret: false
      description: Number of availability zones

    enableNatGateway:
      type: boolean
      required: false
      secret: false
      default: true
      description: Enable NAT Gateway for private subnets

    tags:
      type: object
      required: false
      secret: false
      description: Resource tags

  # NEW in v2: Output declarations
  outputs:
    vpcId:
      type: string
      description: VPC ID for cross-stack references

    vpcArn:
      type: string
      description: VPC ARN

    publicSubnetIds:
      type: array
      description: List of public subnet IDs

    privateSubnetIds:
      type: array
      description: List of private subnet IDs

    natGatewayIds:
      type: array
      description: List of NAT Gateway IDs
```

**Key Changes in v2:**
- ✅ NEW: `parameters` section with `inputs` and `outputs`
- ✅ NEW: Type information for all parameters
- ✅ NEW: Required/optional flags
- ✅ NEW: Secret flags for sensitive data
- ✅ NEW: Descriptions for documentation
- ✅ NEW: **AUTO-GENERATED** from stack code
- ✅ NEW: **Outputs explicitly declared**

---

### Deployment Templates (Unchanged)

**Purpose:** Define **which stacks** to deploy together

**Location:** `./cloud/tools/templates/default/default.yaml`

**Created by:** Platform developers

**Example:**
```yaml
# ./cloud/tools/templates/default/default.yaml
version: "3.1"
template_name: "default"
description: "Full platform deployment"

stacks:
  network:
    enabled: true
    dependencies: []
    config:
      vpcCidr: "10.0.0.0/16"  # Overrides template default

  security:
    enabled: true
    dependencies:
      - network
    config:
      vpcId: "${network.vpcId}"  # References network output

  database-rds:
    enabled: false
    dependencies:
      - network
      - security
```

**No changes in v2** - deployment templates remain focused on orchestration.

---

## Critical Distinction: Deployment Manifest vs Deployment Configs

### Deployment Manifest (User-Editable)

**Purpose:** User-customizable orchestration and configuration overrides

**Location:** `deploy/<deployment-id>/deployment-manifest.yaml`

**Created by:** `cloud init` command (from deployment template)

**Format:** Nested YAML structure

**Editable:** ✅ YES - users customize this file

**Pulumi Reads:** ❌ NO - used to generate config files

**Example:**
```yaml
# deploy/D1TEST1/deployment-manifest.yaml
deployment:
  id: D1TEST1
  org: MyOrg
  project: MyApp

stacks:
  network:
    enabled: true
    config:
      vpcCidr: "10.0.0.0/16"
      availabilityZones: 3

    environments:
      dev:
        config:
          availabilityZones: 2  # Override for dev
      prod:
        config:
          availabilityZones: 3  # Override for prod
```

### Deployment Config Files (Auto-Generated)

**Purpose:** Runtime configuration files that Pulumi actually reads

**Location:** `deploy/<deployment-id>/config/<stack>.<env>.yaml`

**Created by:** ConfigGenerator during `cloud deploy` command

**Format:** Pulumi config format (key:value pairs)

**Editable:** ❌ NO - auto-generated, changes will be overwritten

**Pulumi Reads:** ✅ YES - this is what Pulumi reads

**Example:**
```yaml
# deploy/D1TEST1/config/network.dev.yaml (auto-generated)
network:vpcCidr: "10.0.0.0/16"
network:availabilityZones: "2"
network:deploymentId: "D1TEST1"
network:environment: "dev"
network:org: "MyOrg"
network:project: "MyApp"
```

### The Relationship

```
Deployment Template
        │
        ▼ (cloud init)
Deployment Manifest ◀── User edits this
        │
        ▼ (ConfigGenerator during deploy)
Deployment Configs ◀── Pulumi reads these
        │
        ▼ (pulumi up --config-file)
    Stack Execution
```

### Key Differences

| Aspect | Deployment Manifest | Deployment Configs |
|--------|--------------------|--------------------|
| **File** | `deployment-manifest.yaml` | `config/<stack>.<env>.yaml` |
| **Format** | Nested YAML | Pulumi config (key:value) |
| **Purpose** | Orchestration & overrides | Runtime configuration |
| **Editable** | ✅ YES | ❌ NO |
| **Pulumi Reads** | ❌ NO | ✅ YES |
| **Count** | One per deployment | One per stack per environment |
| **Created by** | `cloud init` | ConfigGenerator |
| **When Created** | During init | During each deploy |

---

## The Four Layers of the Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        LAYER 1: Templates                        │
├──────────────────────────────┬──────────────────────────────────┤
│  Stack Templates (v2)        │  Deployment Templates            │
│  • Per-stack defaults        │  • Orchestration recipes         │
│  • INPUT declarations        │  • Stack selection               │
│  • OUTPUT declarations ◀NEW  │  • Dependencies                  │
└──────────────────────────────┴──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                 LAYER 2: Stack Implementations                   │
├─────────────────────────────────────────────────────────────────┤
│  Stack Code (stacks/*/index.ts)                                 │
│  • Infrastructure as Code (TypeScript + Pulumi)                 │
│  • Reads inputs: config.require/get                             │
│  • Exports outputs ◀── NEW: Must match template                 │
│                                                                  │
│  Validated by: StackCodeValidator ◀── NEW                       │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│     LAYER 3: DEPLOYMENT CONFIGS (Runtime Configuration)          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Deployment Manifest (User-Editable):                            │
│  • Location: deploy/<id>/deployment-manifest.yaml                │
│  • Generated from deployment template                            │
│  • User customizes config overrides                              │
│  • Environment-specific settings                                 │
│                                                                  │
│                    ↓ (ConfigGenerator)                           │
│                                                                  │
│  Deployment Config Files (Auto-Generated): ⭐                    │
│  • Location: deploy/<id>/config/*.yaml                           │
│  • One per stack per environment                                 │
│  • Pulumi config format (network:vpcCidr: "10.0.0.0/16")        │
│  • WHAT PULUMI ACTUALLY READS                                    │
│  • DO NOT EDIT MANUALLY - regenerated on each deploy            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│            LAYER 4: EXECUTION & STATE MANAGEMENT                 │
├─────────────────────────────────────────────────────────────────┤
│  CLI Commands:                                                   │
│  • cloud init        - Generate deployment manifest              │
│  • cloud register-stack ◀── NEW: Auto-extraction                │
│  • cloud validate-stack ◀── NEW: Code validation                │
│  • cloud deploy      ◀── NEW: Generates configs & deploys       │
│                                                                  │
│  Orchestration:                                                  │
│  • DependencyResolver: Cross-stack references                    │
│  • Parallel execution                                            │
│                                                                  │
│  Pulumi Execution:                                               │
│  • pulumi up --config-file deploy/<id>/config/<stack>.<env>.yaml│
│  • Stack deployment                                              │
│  • Output capture and state management                           │
│  • State management                                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## Stack Implementations (Layer 2)

### Stack Code Structure (v2 Validated)

**Location:** `./cloud/stacks/<stack-name>/`

**Structure:**
```
stacks/network/
├── index.ts              # Main stack code
├── Pulumi.yaml           # Pulumi project config
├── package.json          # Dependencies
├── tsconfig.json         # TypeScript config
└── src/                  # Optional: organized modules
    ├── vpc.ts
    ├── subnets.ts
    └── nat-gateway.ts
```

**Example: network/index.ts (v2)**
```typescript
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

const config = new pulumi.Config();

// ═══════════════════════════════════════════════════════════
// INPUTS - Must match template parameters.inputs
// ═══════════════════════════════════════════════════════════

// Required inputs
const vpcCidr = config.require("vpcCidr");
const availabilityZones = config.requireNumber("availabilityZones");

// Optional inputs with defaults
const region = config.get("region") ?? "us-east-1";
const enableNatGateway = config.getBoolean("enableNatGateway") ?? true;
const tags = config.getObject<Record<string, string>>("tags") ?? {};

// ═══════════════════════════════════════════════════════════
// RESOURCE CREATION
// ═══════════════════════════════════════════════════════════

const vpc = new aws.ec2.Vpc("main", {
    cidrBlock: vpcCidr,
    enableDnsHostnames: true,
    enableDnsSupport: true,
    tags: { ...tags, Name: "main-vpc" }
});

// Create subnets, NAT gateways, etc...

// ═══════════════════════════════════════════════════════════
// OUTPUTS - Must match template parameters.outputs
// ═══════════════════════════════════════════════════════════

export const vpcId = vpc.id;
export const vpcArn = vpc.arn;
export const publicSubnetIds = pulumi.output(publicSubnets.map(s => s.id));
export const privateSubnetIds = pulumi.output(privateSubnets.map(s => s.id));
export const natGatewayIds = natGateways.map(ng => ng.id);
```

**NEW in v2:** All exports must be declared in `parameters.outputs` section of the stack template. Validation enforces this.

---

## Complete Configuration Flow

### Enhanced Flow (v2)

```
PHASE 1: Stack Registration (Enhanced)
═══════════════════════════════════════════════════════════════

User runs:
  cloud register-stack network --description "Core networking"

┌─────────────────────────┐
│ 1. Validate Stack       │
│    - Check index.ts     │
│    - Check Pulumi.yaml  │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│ 2. AUTO-EXTRACT ◀─ NEW  │
│    TypeScriptParser     │
│    • Parse index.ts     │
│    • Extract inputs     │
│    • Extract outputs    │
│    • Infer types        │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│ 3. Generate Template    │
│    parameters:          │
│      inputs: {...}      │
│      outputs: {...}     │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│ 4. Save Template        │
│    tools/templates/     │
│    config/network.yaml  │
└──────────┬──────────────┘
           │
           ▼ (if --validate)
┌─────────────────────────┐
│ 5. VALIDATE ◀──── NEW   │
│    StackCodeValidator   │
│    • Compare params     │
│    • Check exports      │
└─────────────────────────┘


PHASE 2: Deployment Initialization
═══════════════════════════════════════════════════════════════

User runs:
  cloud init --template default --deployment-id D1TEST1

┌─────────────────────────┐
│ 1. Load Templates       │
│    • Deployment template│
│    • Stack templates    │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│ 2. Generate Manifest    │
│    Merge:               │
│    • Template defaults  │
│    • Stack templates    │
│    • User overrides     │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│ 3. Create Deployment    │
│    deploy/D1TEST1/      │
│    • manifest.yaml      │
│    • config/ (empty)    │
└─────────────────────────┘


PHASE 3: Deployment Execution (Enhanced)
═══════════════════════════════════════════════════════════════

User runs:
  cloud deploy D1TEST1 -e dev --validate-code

┌─────────────────────────┐
│ 1. Validate Manifest    │
│    • Structure          │
│    • Dependencies       │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│ 2. VALIDATE CODE ◀─ NEW │
│    For each stack:      │
│    • Load template      │
│    • Extract from code  │
│    • Compare            │
│    • Report issues      │
└──────────┬──────────────┘
           │ (if valid)
           ▼
┌─────────────────────────┐
│ 3. Generate Configs     │
│    • Resolve params     │
│    • Create Pulumi cfg  │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│ 4. Deploy Stacks        │
│    • Orchestration      │
│    • Parallel execution │
│    • Output capture     │
└─────────────────────────┘
```

---

## 3-Tier Parameter Resolution

### Resolution Order (v2)

```
┌─────────────────────────────────────────────────────────────┐
│                  PARAMETER RESOLUTION (3 TIERS)              │
└─────────────────────────────────────────────────────────────┘

TIER 1: Stack Template Defaults (v2 Enhanced)
═══════════════════════════════════════════════════════════════
Source: tools/templates/config/network.yaml

parameters:
  inputs:
    vpcCidr:
      type: string
      required: true
      # No default - must be provided
    region:
      type: string
      required: false
      default: us-east-1  ◀── DEFAULT VALUE

Result: region = "us-east-1"


TIER 2: Deployment Manifest Overrides
═══════════════════════════════════════════════════════════════
Source: deploy/D1TEST1/deployment-manifest.yaml

stacks:
  network:
    config:
      region: "us-west-2"  ◀── OVERRIDES DEFAULT

Result: region = "us-west-2"


TIER 3: Environment-Specific Overrides
═══════════════════════════════════════════════════════════════
Source: deploy/D1TEST1/deployment-manifest.yaml

stacks:
  network:
    environments:
      dev:
        config:
          region: "us-east-1"  ◀── ENV OVERRIDE
      prod:
        config:
          region: "us-west-2"  ◀── ENV OVERRIDE

For dev: region = "us-east-1"
For prod: region = "us-west-2"


FINAL RESOLUTION:
═══════════════════════════════════════════════════════════════
Template default → Manifest override → Environment override

Priority: Environment > Manifest > Template
```

### Example Resolution

**Template (network.yaml):**
```yaml
parameters:
  inputs:
    vpcCidr:
      default: "10.0.0.0/16"
    availabilityZones:
      default: 3
    enableNatGateway:
      default: true
```

**Manifest (deployment-manifest.yaml):**
```yaml
stacks:
  network:
    config:
      availabilityZones: 2  # Override
    environments:
      dev:
        config:
          enableNatGateway: false  # Dev override
      prod:
        config:
          enableNatGateway: true   # Prod override
```

**Resolved for dev:**
- vpcCidr: "10.0.0.0/16" (from template)
- availabilityZones: 2 (from manifest)
- enableNatGateway: false (from dev environment)

**Resolved for prod:**
- vpcCidr: "10.0.0.0/16" (from template)
- availabilityZones: 2 (from manifest)
- enableNatGateway: true (from prod environment)

---

## Enhanced Stack Registration Process

### Registration Command (v2)

**Basic Registration:**
```bash
cloud register-stack network --description "Core networking"
```

**With Validation:**
```bash
cloud register-stack security \
  --description "Security groups and IAM" \
  --dependencies "network" \
  --validate
```

**Strict Validation:**
```bash
cloud register-stack prod-stack \
  --description "Production stack" \
  --validate \
  --strict
```

### Auto-Extraction Process

```
┌─────────────────────────────────────────────────────────────┐
│              AUTO-EXTRACTION ARCHITECTURE                    │
└─────────────────────────────────────────────────────────────┘

Stack Code (index.ts)
      │
      ▼
┌──────────────────┐
│TypeScriptParser  │
│ • Regex patterns │
│ • AST analysis   │
│ • Type inference │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ ParseResult      │
│ • inputs[]       │
│ • outputs[]      │
│ • errors[]       │
│ • warnings[]     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ParameterExtractor│
│ • Find main file │
│ • Convert format │
│ • Add metadata   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Template Format  │
│ parameters:      │
│   inputs: {}     │
│   outputs: {}    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│StackTemplate     │
│ Manager          │
│ • Validate       │
│ • Save to file   │
└──────────────────┘
```

### Extraction Rules

**Input Detection:**
```typescript
// Detected as required string
const vpcId = config.require("vpcId");

// Detected as optional string with default
const region = config.get("region", "us-east-1");

// Detected as required number
const port = config.requireNumber("port");

// Detected as optional boolean
const enabled = config.getBoolean("enabled", true);

// Detected as required secret
const password = config.requireSecret("password");

// Detected as required object
const settings = config.requireObject("settings");
```

**Output Detection:**
```typescript
// All detected as outputs
export const vpcId = vpc.id;
export const vpcArn = vpc.arn;
export const subnetIds = subnets.map(s => s.id);
```

---

## Input Parameters: Declaration and Usage

### Declaration in Template (v2)

**Location:** `tools/templates/config/<stack>.yaml`

**Structure:**
```yaml
parameters:
  inputs:
    parameterName:
      type: string | number | boolean | object | array
      required: true | false
      secret: true | false
      default: <value>  # Optional
      description: "..."  # Optional
```

**Example:**
```yaml
parameters:
  inputs:
    # Required string
    vpcCidr:
      type: string
      required: true
      secret: false
      description: VPC CIDR block

    # Optional string with default
    region:
      type: string
      required: false
      secret: false
      default: us-east-1

    # Required secret
    dbPassword:
      type: string
      required: true
      secret: true
      description: Database password

    # Required number
    port:
      type: number
      required: true
      secret: false

    # Optional boolean
    enabled:
      type: boolean
      required: false
      secret: false
      default: true

    # Required object
    tags:
      type: object
      required: true
      secret: false
```

### Usage in Code

```typescript
const config = new pulumi.Config();

// Required parameters
const vpcCidr = config.require("vpcCidr");
const dbPassword = config.requireSecret("dbPassword");
const port = config.requireNumber("port");
const tags = config.requireObject<Record<string, string>>("tags");

// Optional parameters
const region = config.get("region") ?? "us-east-1";
const enabled = config.getBoolean("enabled") ?? true;
```

---

## Output Parameters: Declaration and Usage

### NEW in v2: Output Declaration

**In Template:**
```yaml
parameters:
  outputs:
    vpcId:
      type: string
      description: VPC ID for cross-stack references

    vpcArn:
      type: string
      description: VPC ARN

    subnetIds:
      type: array
      description: List of subnet IDs
```

**In Code:**
```typescript
// These exports must match template declarations
export const vpcId = vpc.id;
export const vpcArn = vpc.arn;
export const subnetIds = subnets.map(s => s.id);
```

### Output Validation

**Validator checks:**
- ✅ All template outputs are exported in code
- ✅ All code exports are declared in template (strict mode)
- ✅ Type consistency

**Example Validation Error:**
```bash
$ cloud validate-stack network --strict

✗ Output 'subnetArns' is exported in code but not declared in template
✗ Output 'vpcEndpoints' is declared in template but not exported in code
```

### Using Outputs in Other Stacks

**In Deployment Manifest:**
```yaml
stacks:
  security:
    config:
      vpcId: "${network.vpcId}"  # Reference network output
      subnetIds: "${network.subnetIds}"
```

**In Stack Code:**
```typescript
// security/index.ts
const config = new pulumi.Config();
const vpcId = config.require("vpcId");  // Resolved from network output
const subnetIds = config.requireObject<string[]>("subnetIds");
```

---

## Template-First Validation

### NEW in v2: Validation System

```
┌─────────────────────────────────────────────────────────────┐
│                   VALIDATION ARCHITECTURE                    │
└─────────────────────────────────────────────────────────────┘

Stack Code          Stack Template
   │                      │
   │ Extract              │ Load
   │                      │
   ▼                      ▼
Parameters          Parameters
(from code)         (from template)
   │                      │
   └──────────┬───────────┘
              │
              ▼
    ┌──────────────────┐
    │StackCodeValidator│
    │                  │
    │ • Compare inputs │
    │ • Compare outputs│
    │ • Check types    │
    │ • Apply rules    │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │ValidationResult  │
    │ ✓ Valid          │
    │ ✗ Errors         │
    │ ⚠ Warnings       │
    └──────────────────┘
```

### Validation Rules

**Input Validation:**
1. ✗ ERROR: Input used in code but not declared in template
2. ⚠ WARNING/✗ ERROR: Input declared but not used (strict mode = error)
3. ⚠ WARNING: Type mismatch between code and template

**Output Validation:**
1. ✗ ERROR: Output declared in template but not exported in code
2. ⚠ WARNING/✗ ERROR: Output exported but not declared (strict mode = error)
3. ⚠ WARNING: Type mismatch

### Validation Commands

**Validate Single Stack:**
```bash
cloud validate-stack network

# Output:
# ============================================================
# ✓ Stack 'network' is valid
#   Code matches template declarations
# ============================================================
```

**Validate with Strict Mode:**
```bash
cloud validate-stack security --strict

# Output:
# ============================================================
# ✗ Stack 'security' validation failed
#
# Errors (2):
#   ✗ Input 'unknownParam' used but not declared
#   ✗ Output 'extraExport' exported but not declared
#
# Warnings (1):
#   ⚠ Input 'deprecated' declared but not used
# ============================================================
```

**Pre-Deployment Validation:**
```bash
cloud deploy D1TEST1 -e dev --validate-code

# Validates all stacks before deployment
```

---

## DependencyResolver: Cross-Stack References

### How Outputs Flow Between Stacks

```
DEPLOYMENT EXECUTION:
═══════════════════════════════════════════════════════════════

Step 1: Deploy network stack
┌──────────────────┐
│  network stack   │
│  Deploys...      │
│                  │
│  Outputs:        │
│  • vpcId         │
│  • subnetIds     │
└────────┬─────────┘
         │ Pulumi saves outputs
         │
         ▼
┌──────────────────┐
│  Pulumi State    │
│  vpcId: vpc-123  │
│  subnetIds: [...] │
└────────┬─────────┘
         │
         │
Step 2: Deploy security stack
         │
         ▼
┌──────────────────┐
│ DependencyResolver│
│ Read network     │
│ outputs          │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  security stack  │
│  Receives:       │
│  • vpcId         │
│  • subnetIds     │
│                  │
│  Creates:        │
│  • Security groups│
└──────────────────┘
```

### Usage in Manifest

```yaml
stacks:
  network:
    enabled: true
    dependencies: []
    # ... config ...

  security:
    enabled: true
    dependencies:
      - network  # Must deploy after network
    config:
      # Reference network outputs using ${stack.output} syntax
      vpcId: "${network.vpcId}"
      subnetIds: "${network.subnetIds}"

  database:
    enabled: true
    dependencies:
      - network
      - security
    config:
      vpcId: "${network.vpcId}"
      securityGroupId: "${security.dbSecurityGroupId}"
```

---

## Cross-Stack Dependency Outputs: Complete Example

### Introduction

This section provides an end-to-end walkthrough of cross-stack dependencies using a real-world example: **database stack depending on network stack outputs** (specifically, private subnet IDs).

### Complete Network → Database Example

#### Network Stack (Provider of Outputs)

**1. Network Stack Template:**

```yaml
# tools/templates/config/network.yaml
name: network
description: Core VPC and networking
dependencies: []
priority: 100

parameters:
  inputs:
    vpcCidr:
      type: string
      required: true
      description: VPC CIDR block

    availabilityZones:
      type: number
      required: true
      description: Number of AZs

  outputs:
    vpcId:
      type: string
      description: VPC ID

    privateSubnetIds:
      type: array
      description: Private subnet IDs for databases ⭐
```

**2. Network Stack Code:**

```typescript
// stacks/network/index.ts
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

const config = new pulumi.Config();
const vpcCidr = config.require("vpcCidr");
const azCount = config.requireNumber("availabilityZones");

// Create VPC
const vpc = new aws.ec2.Vpc("main", {
    cidrBlock: vpcCidr,
    enableDnsHostnames: true
});

// Create private subnets
const privateSubnets: aws.ec2.Subnet[] = [];
for (let i = 0; i < azCount; i++) {
    const subnet = new aws.ec2.Subnet(`private-${i}`, {
        vpcId: vpc.id,
        cidrBlock: `10.0.${100 + i}.0/24`,
        availabilityZone: `us-east-1${String.fromCharCode(97 + i)}`
    });
    privateSubnets.push(subnet);
}

// ⭐ Export outputs
export const vpcId = vpc.id;
export const privateSubnetIds = pulumi.output(privateSubnets.map(s => s.id));
```

#### Database Stack (Consumer of Outputs)

**3. Database Stack Template:**

```yaml
# tools/templates/config/database-rds.yaml
name: database-rds
description: PostgreSQL database
dependencies:
  - network  # ⭐ Declares dependency
priority: 300

parameters:
  inputs:
    dbName:
      type: string
      required: true

    dbPassword:
      type: string
      required: true
      secret: true

    # ⭐ Inputs from network
    vpcId:
      type: string
      required: true
      description: VPC ID (from network.vpcId)

    privateSubnetIds:
      type: array
      required: true
      description: Subnet IDs (from network.privateSubnetIds) ⭐

  outputs:
    dbEndpoint:
      type: string
      description: Database endpoint
```

**4. Database Stack Code:**

```typescript
// stacks/database-rds/index.ts
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

const config = new pulumi.Config();
const dbName = config.require("dbName");
const dbPassword = config.requireSecret("dbPassword");

// ⭐ Read network outputs (resolved at runtime)
const vpcId = config.require("vpcId");
const privateSubnetIds = config.requireObject<string[]>("privateSubnetIds");

// Create DB subnet group using network's subnets
const dbSubnetGroup = new aws.rds.SubnetGroup("main", {
    subnetIds: privateSubnetIds  // ⭐ Uses network subnets
});

// Create database
const db = new aws.rds.Instance("main", {
    identifier: dbName,
    engine: "postgres",
    instanceClass: "db.t3.micro",
    password: dbPassword,
    dbSubnetGroupName: dbSubnetGroup.name,
    skipFinalSnapshot: true
});

export const dbEndpoint = db.endpoint;
```

#### Deployment Configuration

**5. Deployment Manifest:**

```yaml
# deploy/D1PROD1/deployment-manifest.yaml
stacks:
  network:
    enabled: true
    dependencies: []
    config:
      vpcCidr: "10.0.0.0/16"
      availabilityZones: 3

  database-rds:
    enabled: true
    dependencies:
      - network  # ⭐ Deploy after network
    config:
      dbName: "myappdb"
      dbPassword: "${env.DB_PASSWORD}"

      # ⭐ Reference network outputs
      vpcId: "${network.vpcId}"
      privateSubnetIds: "${network.privateSubnetIds}"
```

### Deployment Flow with Resolution

```
DEPLOYMENT SEQUENCE:
═══════════════════════════════════════════════════════════════

STEP 1: Deploy Network Stack
─────────────────────────────────────────────────────────────
$ cloud deploy D1PROD1 -e dev

• Load deployment manifest
• Resolve dependencies: network has no dependencies
• Deploy network:
    cd stacks/network
    pulumi up --stack dev \
      --config-file ../../deploy/D1PROD1/config/network.dev.yaml

✓ Network deployed successfully
  Captured outputs:
    vpcId: vpc-0a1b2c3d4e5f6g7h8
    privateSubnetIds: ["subnet-111", "subnet-222", "subnet-333"]

STEP 2: Resolve Database Dependencies
─────────────────────────────────────────────────────────────
• DependencyResolver reads network outputs from Pulumi state
• PlaceholderResolver performs substitution:
    ${network.vpcId} → "vpc-0a1b2c3d4e5f6g7h8"
    ${network.privateSubnetIds} → ["subnet-111", "subnet-222", "subnet-333"]

• ConfigGenerator creates database-rds.dev.yaml:
    database-rds:vpcId: "vpc-0a1b2c3d4e5f6g7h8"
    database-rds:privateSubnetIds: ["subnet-111", "subnet-222", "subnet-333"]
    database-rds:dbName: "myappdb"
    database-rds:dbPassword: "secret123"

STEP 3: Deploy Database Stack
─────────────────────────────────────────────────────────────
• Deploy database with resolved values:
    cd stacks/database-rds
    pulumi up --stack dev \
      --config-file ../../deploy/D1PROD1/config/database-rds.dev.yaml

✓ Database deployed successfully
  Used network outputs:
    - vpcId from network (vpc-0a1b2c3d4e5f6g7h8)
    - 3 subnets from network

  Captured outputs:
    dbEndpoint: myappdb.abc123.us-east-1.rds.amazonaws.com:5432
```

### Registration Commands

```bash
# Register network stack
$ cloud register-stack network \
    --description "Core VPC and networking" \
    --priority 100

Extracting parameters from network...
  Found 2 input(s) and 2 output(s)
✓ Stack 'network' registered
  Outputs declared: vpcId, privateSubnetIds ⭐

# Register database stack
$ cloud register-stack database-rds \
    --description "PostgreSQL database" \
    --dependencies "network" \
    --priority 300

Extracting parameters from database-rds...
  Found 4 input(s) and 1 output(s)
✓ Stack 'database-rds' registered
  Dependencies: network
  Inputs from dependencies:
    - vpcId (from network.vpcId)
    - privateSubnetIds (from network.privateSubnetIds) ⭐
```

### Key Takeaways

1. **Template Declarations:**
   - Network declares `privateSubnetIds` as OUTPUT
   - Database declares `privateSubnetIds` as INPUT
   - Database lists `network` in dependencies

2. **No Direct Coupling:**
   - Network code has no knowledge of database
   - Database reads from config, not directly from network
   - Loose coupling through configuration layer

3. **Type Safety:**
   - Both stacks declare `privateSubnetIds` as `array`
   - Platform validates type compatibility
   - Runtime checks prevent type mismatches

4. **Automatic Resolution:**
   - DependencyResolver fetches outputs from deployed stacks
   - PlaceholderResolver substitutes `${...}` references
   - ConfigGenerator creates runtime config files

5. **Deployment Order:**
   - Dependencies ensure correct deployment sequence
   - Outputs captured after each stack deploys
   - Dependent stacks receive resolved values

### Common Patterns

**Pattern 1: Single Dependency:**
```yaml
database-rds:
  dependencies: [network]
  config:
    vpcId: "${network.vpcId}"
    subnetIds: "${network.privateSubnetIds}"
```

**Pattern 2: Multiple Dependencies:**
```yaml
application:
  dependencies: [network, security, database-rds]
  config:
    vpcId: "${network.vpcId}"
    securityGroupId: "${security.appSecurityGroupId}"
    dbEndpoint: "${database-rds.dbEndpoint}"
```

**Pattern 3: Chained Dependencies:**
```yaml
network → security → database → application

Each stack outputs values needed by the next layer.
```

### Troubleshooting

**Error:** "Output 'privateSubnetIds' not found"
- **Cause:** Network not deployed or output name mismatch
- **Fix:** Verify network deployment and output name

**Error:** "Type mismatch: expected array, got string"
- **Cause:** Type declarations don't match
- **Fix:** Ensure both templates declare consistent types

**Error:** "Circular dependency detected"
- **Cause:** Stack A depends on B, B depends on A
- **Fix:** Restructure to break the circular reference

---

## Directory Structure Complete Map

```
cloud/
├── tools/
│   ├── templates/
│   │   ├── config/                    ◀── Stack Templates (v2)
│   │   │   ├── network.yaml           (Per-stack with inputs/outputs)
│   │   │   ├── security.yaml
│   │   │   ├── database-rds.yaml
│   │   │   └── ... (one per stack)
│   │   │
│   │   └── default/                   ◀── Deployment Templates
│   │       ├── default.yaml           (Full deployment)
│   │       ├── minimal.yaml           (Minimal deployment)
│   │       └── microservices.yaml     (Microservices)
│   │
│   ├── cli/src/cloud_cli/
│   │   ├── commands/
│   │   │   ├── stack_cmd.py           ◀── Enhanced registration
│   │   │   └── deploy_cmd.py          ◀── Enhanced deployment
│   │   │
│   │   └── parser/                    ◀── NEW in v2
│   │       ├── typescript_parser.py   (AST parsing)
│   │       └── parameter_extractor.py (High-level API)
│   │
│   └── core/cloud_core/
│       ├── templates/
│       │   └── stack_template_manager.py  ◀── Enhanced format
│       │
│       └── validation/
│           └── stack_code_validator.py    ◀── NEW in v2
│
├── stacks/                            ◀── Stack Implementations
│   ├── network/
│   │   ├── index.ts                   (Main code)
│   │   ├── Pulumi.yaml
│   │   ├── package.json
│   │   └── src/                       (Optional modules)
│   │
│   ├── security/
│   ├── database-rds/
│   └── ... (one directory per stack)
│
└── deploy/                            ◀── Deployments
    ├── D1TEST1-CompanyA-ecommerce/
    │   ├── deployment-manifest.yaml   (Generated from template)
    │   ├── config/                    (Generated configs)
    │   │   ├── network-dev.yaml
    │   │   └── security-dev.yaml
    │   └── .pulumi/                   (Pulumi state)
    │
    └── D2PROD1-CompanyA-ecommerce/
        └── ... (another deployment)
```

---

## Example: Full Lifecycle Walkthrough

### Scenario: Deploy Network + Security + Database

**Step 1: Register Stacks (v2)**

```bash
# Register network stack with auto-extraction
$ cloud register-stack network \
    --description "Core VPC and networking" \
    --priority 100

Extracting parameters from network...
  Found 5 input(s) and 4 output(s)
✓ Stack 'network' registered successfully
  Template: tools/templates/config/network.yaml
  Parameters: 5 inputs, 4 outputs


# Register security stack
$ cloud register-stack security \
    --description "Security groups and IAM" \
    --dependencies "network" \
    --priority 200 \
    --validate

Extracting parameters from security...
  Found 3 input(s) and 2 output(s)
✓ Stack 'security' registered successfully

Validating stack code...
✓ Validation passed


# Register database stack
$ cloud register-stack database-rds \
    --description "PostgreSQL RDS database" \
    --dependencies "network,security" \
    --priority 300 \
    --validate --strict

Extracting parameters from database-rds...
  Found 6 input(s) and 3 output(s)
✓ Stack 'database-rds' registered successfully

Validating stack code (strict mode)...
✓ Validation passed
```

**Step 2: Review Generated Templates**

```bash
$ ls tools/templates/config/
network.yaml
security.yaml
database-rds.yaml

$ cat tools/templates/config/network.yaml
```

```yaml
name: network
description: Core VPC and networking
dependencies: []
priority: 100
parameters:
  inputs:
    vpcCidr:
      type: string
      required: true
      secret: false
      description: VPC CIDR block
    # ... other inputs ...
  outputs:
    vpcId:
      type: string
      description: VPC ID
    # ... other outputs ...
```

**Step 3: Initialize Deployment**

```bash
$ cloud init \
    --template default \
    --deployment-id D1TEST1 \
    --org CompanyA \
    --project ecommerce

✓ Deployment 'D1TEST1' created
  Directory: deploy/D1TEST1-CompanyA-ecommerce/
  Manifest: deployment-manifest.yaml
  Enabled stacks: network, security, database-rds
```

**Step 4: Customize Deployment**

Edit `deploy/D1TEST1-CompanyA-ecommerce/deployment-manifest.yaml`:

```yaml
stacks:
  network:
    enabled: true
    dependencies: []
    config:
      vpcCidr: "10.1.0.0/16"  # Custom CIDR
      availabilityZones: 3
    environments:
      dev:
        config:
          availabilityZones: 2  # Dev uses 2 AZs
          enableNatGateway: false
      prod:
        config:
          availabilityZones: 3  # Prod uses 3 AZs
          enableNatGateway: true

  security:
    enabled: true
    dependencies:
      - network
    config:
      vpcId: "${network.vpcId}"  # Reference network output

  database-rds:
    enabled: true
    dependencies:
      - network
      - security
    config:
      dbName: "myapp"
      instanceClass: "db.t3.micro"
      allocatedStorage: 20
      subnetIds: "${network.privateSubnetIds}"  # Reference
```

**Step 5: Validate Before Deployment**

```bash
$ cloud deploy D1TEST1 -e dev --validate-code

Validating deployment...
✓ Manifest and dependencies valid

Validating stack code against templates...
  Validated: 3 stack(s)
  Valid: 3/3
✓ Code validation passed

Proceed with deployment? [y/N]:
```

**Step 6: Deploy**

```bash
$ cloud deploy D1TEST1 -e dev

Deploying D1TEST1 to dev

Creating orchestration plan...
Layer 1: network
Layer 2: security
Layer 3: database-rds

Deploying network...
  Creating VPC...
  Creating subnets...
  ✓ network deployed (45s)
  Outputs: vpcId=vpc-123, subnetIds=[subnet-1,subnet-2]

Deploying security...
  Using vpcId=vpc-123
  Creating security groups...
  ✓ security deployed (12s)
  Outputs: dbSecurityGroupId=sg-456

Deploying database-rds...
  Using vpcId=vpc-123, securityGroupId=sg-456
  Creating DB instance...
  ✓ database-rds deployed (180s)
  Outputs: dbEndpoint=mydb.xyz.us-east-1.rds.amazonaws.com

✓ Deployment completed successfully
```

---

## Advanced Topics

### Custom Validation Rules

**Create custom validator:**
```python
from cloud_core.validation.stack_code_validator import StackCodeValidator

class CustomValidator(StackCodeValidator):
    def _validate_inputs(self, code_inputs, template_inputs, result, strict):
        super()._validate_inputs(code_inputs, template_inputs, result, strict)

        # Add custom rules
        for input_name, input_config in code_inputs.items():
            if input_config.get("secret") and not input_name.endswith("Password"):
                result.add_warning(
                    f"Secret input '{input_name}' should end with 'Password'",
                    location=f"input:{input_name}"
                )
```

### Template Inheritance

**Base template:**
```yaml
# base-stack.yaml
parameters:
  inputs:
    region:
      type: string
      default: us-east-1
    tags:
      type: object
      default:
        ManagedBy: cloud-0.7
```

**Derived template:**
```yaml
# network.yaml
extends: base-stack.yaml
parameters:
  inputs:
    vpcCidr:
      type: string
      required: true
    # Inherits region and tags from base
```

### Multi-Region Deployments

**Deployment manifest:**
```yaml
stacks:
  network:
    environments:
      us-east-1:
        config:
          region: us-east-1
          vpcCidr: "10.1.0.0/16"
      us-west-2:
        config:
          region: us-west-2
          vpcCidr: "10.2.0.0/16"
```

---

## Summary and Quick Reference

### Key Concepts (v2)

| Concept | Location | Purpose | Enhanced in v2 |
|---------|----------|---------|----------------|
| Stack Template | `tools/templates/config/<stack>.yaml` | Per-stack config defaults + output declarations | ✅ YES |
| Deployment Template | `tools/templates/default/<template>.yaml` | Orchestration recipe | No |
| Stack Code | `stacks/<stack>/index.ts` | Infrastructure implementation | Validated |
| Deployment Manifest | `deploy/<id>/deployment-manifest.yaml` | Deployment-specific config | No |
| Parameter Extractor | `cloud_cli/parser/` | Auto-extract from code | ✅ NEW |
| Code Validator | `cloud_core/validation/` | Enforce consistency | ✅ NEW |

### Command Quick Reference (v2)

```bash
# Registration (Enhanced)
cloud register-stack <name> -d "..." [--validate] [--strict]

# Validation (New)
cloud validate-stack <name> [--strict]

# List registered stacks
cloud list-stacks

# Initialize deployment
cloud init --template <template> --deployment-id <id>

# Deploy with validation (Enhanced)
cloud deploy <id> -e <env> [--validate-code] [--strict]
```

### Template Format (v2)

```yaml
name: <stack-name>
description: <description>
dependencies: [<stack-names>]
priority: <number>

# ENHANCED v2
parameters:
  inputs:
    <param-name>:
      type: string|number|boolean|object|array
      required: true|false
      secret: true|false
      default: <value>
      description: <text>

  outputs:
    <output-name>:
      type: string|number|boolean|object|array
      description: <text>
```

### Validation Rules

| Scenario | Normal Mode | Strict Mode |
|----------|-------------|-------------|
| Input used but not declared | ✗ ERROR | ✗ ERROR |
| Input declared but not used | ⚠ WARNING | ✗ ERROR |
| Output declared but not exported | ✗ ERROR | ✗ ERROR |
| Output exported but not declared | ⚠ WARNING | ✗ ERROR |
| Type mismatch | ⚠ WARNING | ⚠ WARNING |

---

## End of Guide v4.5

**Version:** 4.5 (Enhanced)
**Status:** Fully Implemented
**Coverage:** 87%
**Features:** Auto-extraction, Output support, Validation

For detailed implementation, see: `Stack_Parameters_and_Registration_Guide_v2.md`
For usage examples, see: `Enhanced_Stack_Registration_Usage_Guide.md`
